
<script>
  const TeamWorkingCalendar = {
    data: () => ({
      selectedDate: '',
      view: 'week-scheduler',
      views: [
        {text: 'Tháng', value: 'month-scheduler'},
        {text: 'Tuần', value: 'week-scheduler'},
        {text: 'Ngày', value: 'day-scheduler'}
      ],
      weekday: [1, 2, 3, 4, 5, 6, 0],
      weekdays: [
        { text: 'Mon - Sun', value: [1, 2, 3, 4, 5, 6, 0] },
        { text: 'Sun - Sat', value: [0, 1, 2, 3, 4, 5, 6] },
      ],
      selectedDepartment: null,
      selectedEvent: [],
      selectedOpen: false,
    }),
    computed: {
      ...Vuex.mapState({
        loading: "loading",
        loginUser: "loginUser",
        statusColor: 'statusColor',
        usersFilter: 'users',
      }),
      ...Vuex.mapGetters({
        isAdmin: "isAdmin",
        isHR: "isHR",
        listDepartments: 'listDepartments',
        workingCalendarTeamFilter: 'workingCalendarTeamFilter',
      }),
      resources(){
        return (!this.selectedDepartment) ? this.usersFilter.items.filter(item => item.department !== '' && item.department === this.loginUser.department) : this.usersFilter.items.filter(item => item.department !== '' && item.department === this.selectedDepartment)
      },
      getMonthYear () {
        const date = (this.selectedDate) ? new Date(this.selectedDate) : new Date()
        const monthYear = `${date.getMonth()+1}/${date.getFullYear()}`
        return monthYear
      },
    },
    methods: {
      getDateTimeFormat(date,time) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date)
        const formattedTime = new Date(time);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();
        const hours = formattedTime.getHours().toString().padStart(2, '0');
        const minutes = formattedTime.getMinutes().toString().padStart(2, '0');
        const dateFormat1 = `${day}/${month}/${year}`
        const dateFormat2 = `${year}-${month}-${day}`
        const timeFormat = `${hours}:${minutes}`
        const dateTimeFormat = `${dateFormat2} ${timeFormat}`

        return {dateFormat1, timeFormat, dateFormat2, dateTimeFormat};
      },
      calendarToday () {
        this.$refs.calendar.moveToToday()
      },
      calendarNext () {
        this.$refs.calendar.next()
      },
      calendarPrev () {
        this.$refs.calendar.prev()
      },
      isCssColor (color) {
        return !!color && !!color.match(/^(#|(rgb|hsl)a?\()/)
      },
      badgeClasses (event, type) {
        const cssColor = this.isCssColor(event.bgcolor)
        const isHeader = type === 'header'
        return {
          [`text-white bg-${event.bgcolor}`]: !cssColor,
          'full-width': !isHeader && (!event.side || event.side === 'full'),
          'left-side': !isHeader && event.side === 'left',
          'right-side': !isHeader && event.side === 'right'
        }
      },
      badgeStyles (event, type, timeStartPos, timeDurationHeight) {
        const s = {}
        if (this.isCssColor(event.bgcolor)) {
          s['background-color'] = event.bgcolor
          s.color = luminosity(event.bgcolor) > 0.5 ? 'black' : 'white'
        }
        if (timeStartPos) {
          s.top = timeStartPos(event.time) + 'px'
        }
        if (timeDurationHeight) {
          s.height = timeDurationHeight(event.duration) + 'px'
        }
        s['align-items'] = 'flex-start'
        return s
      },
      getEvents (date, employeeCode) {
        const dateFormat = new Date(date).setHours(0,0,0,0)
        const items = this.workingCalendarTeamFilter.filter((item) => item.employeeCode === employeeCode && new Date(item.startDate).setHours(0,0,0,0) <= dateFormat && new Date(item.endDate).setHours(0,0,0,0) >= dateFormat)
        const dataEvents = [];
        items.forEach(item => {
          const title = item.workingTimeTypeName || item.leaveTypes || item.timeSheetType 
          const {dateFormat1: startDateFormat1, timeFormat: startShift, dateFormat2: startDateFormat2} = this.getDateTimeFormat(item.startDate, item.startShift)
          const {dateFormat1: endDateFormat1, timeFormat: endShift, dateFormat2: endDateFormat2} = this.getDateTimeFormat(item.endDate, item.endShift)
          const event = {
          title: title,
          date: startDateFormat2,
          endDate: endDateFormat2,
          startShift: startShift,
          endShift: endShift,
          bgcolor: this.getEventColor({ name: title }),
          detail: `${title} từ ${startShift} ngày ${startDateFormat1} đến ${endShift} ngày ${endDateFormat1}`
          };
          dataEvents.push(event);
        });
        return dataEvents
      },
      getEventColor (event) {
          const colorMap = {
          'Lịch làm việc': 'cyan',
          'Nghỉ phép năm': 'indigo',
          'Làm việc tại nhà': 'deep-purple',
          'Nghỉ bù': 'accent',
          'Nghỉ không lương': 'green',
          'Chấm công vân tay': 'orange'
        };
        return colorMap[event.name] || 'grey darken-1';
      },
      onClickResourceDay2 (data) {
        const dataEvents = this.getEvents(data.scope.timestamp.date, data.scope.resource.Employee_code)
        const open = () => {
          this.selectedEvent = dataEvents
          if(this.selectedEvent.length > 0) {
            this.selectedOpen = true
            return this.selectedEvent
          }
        }
        if (this.selectedOpen) {
          this.selectedOpen = false
          open()
        } else {
          open()
        }
      },
    },
    template: `
      <?!= include_('dashboard/Pages/WorkingCalendar/TeamWorkingCalendar_template.html'); ?>
      `
  }
</script>

