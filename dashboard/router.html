<script src="https://unpkg.com/vue-router@3"></script>
<!-- <script src="https://res.cloudinary.com/dpwmd0kym/raw/upload/v1692100348/unpkg.com_vue-router_3.6.5_dist_vue-router_tabjvt.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.core.min.js" integrity="sha512-UhlYw//T419BPq/emC5xSZzkjjreRfN3426517rfsg/XIEC02ggQBb680V0VvP+zaDZ78zqse3rqnnI5EJ6rxA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script>

  const LoginView = {
    data: () =>({
      form: Utils.copyObject(Forms.Login, true),
    }),
    computed: {
      ...Vuex.mapState({
        loading: "loading",
        statusColor: 'statusColor',
      })
    },
    methods: {
      async login(){
        if (!this.$refs.form.validate()) return
        const item = Utils.getFormValues(this.form)
        // console.log(this.form)
        const success = await this.$store.dispatch("login", {item})
      },
      async loginGoogle() {
        const success = await this.$store.dispatch("getDataLoginUser","getAppInfo")
      }
    },
    template: `
      <?!= include_('dashboard/view/login.html'); ?>
    `
  }

  const Dashboard = {
    data: ()=>({
      form: Utils.copyObject(Forms.ResignForm, true),
      reviewForm: Utils.copyObject(Forms.ReviewForm, true),
      leaveForm: Utils.copyObject(Forms.LeaveForm, true),
      dialog: {},
      dialogReviewForm: {},
      dialogLeaveForm: {},
      itemsSection: [
        {
          color: '#E91E63',
          src: 'https://res.cloudinary.com/dpwmd0kym/image/upload/v1692336491/Kyna%20Project/v-card/Sotaynhanvien_kyqznt.png',
          title: 'Sổ tay nhân viên',
          subtitle: 'Lịch sử hình thành Kyna, văn hóa Kyna',
          showDialog: false,
          content: '<iframe src="https://docs.google.com/presentation/d/e/2PACX-1vSryW4Q24wZXk0vQXYZlFv8dCZH4Mo93n3FfTtnTajxF_Q5nVAPG6SA_ChhKwi7-ThtDrN8sC3mbnBm/embed?start=false&loop=false&delayms=3000" frameborder="1" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>',
        },
        {
          color: 'warning',
          src: 'https://res.cloudinary.com/dpwmd0kym/image/upload/v1692335664/Kyna%20Project/v-card/Noiquylaodong_no7a9l.png',
          title: 'Nội quy lao động',
          subtitle: 'Quy tắc, quy chế làm việc của Kyna',
          showDialog: false,
          content: '<iframe src="https://docs.google.com/document/d/e/2PACX-1vT0pBK2lzrCA8DtCXxC8KDz5UOObyaANqfWkE14Lhse0DRZeKg_fx2e6kDn7m5WFRYk4TwEu1neI7pk/pub?embedded=true" frameborder="1" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>',
        },
        {
          color: 'info',
          src: 'https://res.cloudinary.com/dpwmd0kym/image/upload/v1692335344/Kyna%20Project/v-card/Quytrinhnhansu_wklfpl.png',
          title: 'Quy trình cần biết',
          subtitle: 'Quy trình thanh toán, nghỉ phép...',
          showDialog: false,
          content: '<iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ24R-MKiQJrTOjfxDSC6VfN4Z2OBkCGLgWZHKraKeXID92OtUaegm2StIbDKj5nAmfzLEuRY8VpD6_/pubhtml?widget=true&amp;headers=false" frameborder="1" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>'
        },
      ],
      leaveDayRanges: [{
        startShift:'',
        startDate:'',
        endShift:'',
        endDate:'',
      }],
      menuDate: [{
        menuDate1: false,
        menuDate2: false,
      }],
      workingShifts: ["Sáng","Chiều","C1(Đầu)","C1(Cuối)","C2(Đầu)","C2(Cuối)","C3(Đầu)","C3(Cuối)"],
      rules: {required: [v => !!v || "This is a required filed"],}
    }),

    computed:{
      ...Vuex.mapState({
        loading: 'loading',
        loginUser: 'loginUser',
        statusColor: 'statusColor',
        sectionDialog: 'dialog',
        leaveTypes: 'leaveTypes',
      }),
      ...Vuex.mapGetters({
        listLeaveTypes: 'listLeaveTypes',
        assignedToEmails: 'assignedToEmails',
        listDepartments: 'listDepartments',
      }),
     
    },
   
    methods: {
      formatDate (date) {
        if (!date) return null

        const [year, month, day] = date.split('-')
        return `${day}/${month}/${year}`
      },
      infoLeaveType(value) {
        const a = this.leaveTypes.items.filter(item => item.leaveTypeName === value)
        const a1 = a.map(item => item.isCountSalary)
        const a2 = a.map(item => item.maxLeaveNo)
        const a3 = a.map(item => item.leaveTypeUnit)
        const result = (a2[0] === '') ? `${a1[0]} tính công` : `${a1[0]} tính công (tối đa: ${a2[0]} ${a3[0]})`
        return (value.length === 0) ? '' : result
      },
      async onPageLoad(){
        const loginUser = this.$store.state.loginUser 
      },
      async submit(){
        if (!this.$refs.form.validate()) return
        const item = Utils.getFormValues(this.form)
        // console.log(this.form)
        const success = await this.$store.dispatch("createResignForms", {item})
        if (success) this.dialog.show = false
      },
      showResignForm(item){
        const loginUser = this.$store.state.loginUser
        this.form = Utils.copyObject(Forms.ResignForm, true)
        this.form.fullName.items = loginUser.cv_name
        this.form.userEmail.items = loginUser.employee_email
        this.form.employeeCode.items = loginUser.Employee_code
        this.form.department.items = loginUser.department
        this.form.position.items = loginUser.position
        this.$refs.form && this.$refs.form.resetValidation()
        this.dialog = {
          show: true,
          type: "Create",
          title: "Đơn xin thôi việc",
          color: "primary",
          icon: "mdi-plus",
        }
      },
      showReviewForm(item){
        const loginUser = this.$store.state.loginUser
        this.reviewForm = Utils.copyObject(Forms.ReviewForm, true)
        this.reviewForm.fullName.items = loginUser.cv_name
        this.reviewForm.userEmail.items = loginUser.employee_email
        this.reviewForm.applyEmployeeDepartment.items = this.$store.getters.listDepartments
        this.$refs.reviewForm && this.$refs.reviewForm.resetValidation()
        this.dialogReviewForm = {
          show: true,
          type: "Create",
          title: "Đề xuất điều chỉnh quyền lợi nhân viên",
          color: "primary",
          icon: "mdi-plus",
        }
      },
      showLeaveForm(item){
        const loginUser = this.$store.state.loginUser
        this.leaveForm = Utils.copyObject(Forms.LeaveForm, true)
        this.leaveForm.employeeName.items = loginUser.cv_name
        this.leaveForm.employeeCode.items = loginUser.Employee_code
        this.leaveForm.department.items = loginUser.department
        this.leaveForm.leaveTypes.items = this.listLeaveTypes
        this.leaveForm.assignedToEmails.items = this.assignedToEmails
        this.$refs.leaveForm && this.$refs.leaveForm.resetValidation()
        this.dialogLeaveForm = {
          show: true,
          type: "Create",
          title: "Đơn xin nghỉ phép, làm việc tại nhà",
          color: "primary",
          icon: "mdi-plus",
          width: "800"
        }
      },
      async submitReviewForm(){
        if (!this.$refs.reviewForm.validate()) return
        const item = Utils.getFormValues(this.reviewForm)
        // console.log(item)
        const success = await this.$store.dispatch("createReviewForm", {item})
        if (success) this.dialogReviewForm.show = false
      },
      async submitLeaveForm(){
        if (!this.$refs.leaveForm.validate()) return
        const item = Utils.getFormValues(this.leaveForm)
        item.requestedBy = this.loginUser.employee_email
        const dataApprovals = JSON.stringify(item.assignedToEmails.map(email => ({email, status: "Pending", comments: '', timestamp: ''})))
        const dataAutoApproval = JSON.stringify(item.assignedToEmails.map(email => ({email, status: "Approved", comments: 'Đã tự động phê duyệt', timestamp: new Date()})))
        // item.dataApprovals = JSON.stringify(item.assignedToEmails.map(email => ({email, status: "Pending", comments: '', timestamp: ''})))
        item.dataApprovals = (this.loginUser.level === 'C-level' || this.loginUser.level === 'Manager' || this.loginUser.level === 'Director') ? dataAutoApproval : dataApprovals
        item.status = (this.loginUser.level === 'C-level' || this.loginUser.level === 'Manager' || this.loginUser.level === 'Director') ? 'Approved' : 'Pending'
        item.dataLeaveDays = JSON.stringify(this.leaveDayRanges)
        item.pendingOn = item.assignedToEmails[0]
        item.assignedToEmails = JSON.stringify(item.assignedToEmails)
        const success = await this.$store.dispatch("createItem", { createItemDB: "leaveDaysDatabase", sheetName: "leaveRequests", item})
        // console.log(item)
        if (success) this.dialogLeaveForm.show = false
        await this.onPageLoad()
      },
      addMoreLeaveDay() {
        this.leaveDayRanges.push({
          startShift:'',
          startDate:'',
          endShift:'',
          endDate:'',
        })
      },
      deleteLeaveDay(index) {
        if(this.leaveDayRanges.length > 1) {
          this.leaveDayRanges.splice(index,1);
        }
      },
    },
    created(){
      // this.onPageLoad()
    },
    template: `<?!= include_('dashboard/view/home.html'); ?>`
  }


  const ReceivedLeaves = {
    data: ()=>({
      page: 1,
      pageSize: -1,
      headers: [
        // {text: "ID", value: "id"},
        {text: "Mã nhân viên", value: "employeeCode"},
        {text: "Tên nhân viên", value: "employeeName"},
        {text: "Team", value: "department"},
        {text: "Leave Type", value: "leaveTypes"},
        {text: "Lý do", value: "requestReason"},
        {text: "Chi tiết ngày nghỉ", value: "dataLeaveDays"},
        {text: "Status", value: "status"},
        {text: "Created At", value: "createdAt"},
        {text: "Actions", value: "actions"},
      ],
      form: Utils.copyObject(Forms.LeaveForm, true),
      search: Utils.copyObject(Forms.Search),
      dialog: {},
      comments: {
        label: "Comments",
        value: null,
        type: "textarea",
        icon: "mdi-comment-text",
      },
    }),
    computed:{
      ...Vuex.mapState({
        loading: 'loading',
        loginUser: 'loginUser',
        statusColor: 'statusColor',
      }),
      ...Vuex.mapGetters({
        items: 'receivedLeaves',
        assignedToEmails: 'assignedToEmails',
      }),
    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      async onPageLoad(){
        this.$store.dispatch("getItems", {
          getItemDB: "leaveDaysDatabase",
          sheetName: "leaveRequests", 
          page: this.page, 
          pageSize: this.pageSize, 
          filters: {
            pendingOn: this.loginUser.employee_email,
            status: "Pending",  
          },
        })
      },
      async submit(){
        if (!this.$refs.form.validate()) return
        const item = {
          id: this.form.id.value,
          comments: this.comments.value,
          // assignedTo: this.form.assignedToEmails.value,
          type: this.dialog.type,
        }
        const success = await this.$store.dispatch("updateApproval", {updateApprovalDB: "leaveDaysDatabase", sheetName: "leaveRequests",item})
        // console.log(item)
        if (success) this.dialog.show = false
        await this.onPageLoad()
      },
      showApproveForm(item){
        this.form = Utils.copyObject(Forms.LeaveForm, true)
        this.form.assignedToEmails.items = this.assignedToEmails
        Utils.updateFormValues(this.form, item, true)
        this.$refs.form && this.$refs.form.resetValidation()
        this.comments.value = null
        this.dialog = {
          show: true,
          type: "Approve",
          title: "Approve",
          color: "success",
          icon: "mdi-check",
        }
      },
      showRejectForm(item){
        this.form = Utils.copyObject(Forms.LeaveForm, true)
        this.form.assignedToEmails.items = this.assignedToEmails
        Utils.updateFormValues(this.form, item, true)
        this.$refs.form && this.$refs.form.resetValidation()
        this.comments.value = null
        this.dialog = {
          show: true,
          type: "Reject",
          title: "Reject",
          color: "error",
          icon: "mdi-close",
        }
      },
      // showForwardForm(item){
      //   this.form = Utils.copyObject(Forms.LeaveForm, true)
      //   // this.form.assignedToEmails.items = this.assignedToEmails.filter(v => !item.assignedToEmails.includes(v) && item.requestedBy !== v)
      //   this.form.assignedToEmails.items = this.assignedToEmails.filter(v => !item.assignedToEmails.includes(v))
      //   Utils.updateFormValues(this.form, item)
      //   this.form.assignedToEmails.value = null
      //   this.form.assignedToEmails.multiple = false
      //   this.form.request.disabled = true
      //   this.$refs.form && this.$refs.form.resetValidation()
      //   this.comments.value = null
      //   this.dialog = {
      //     show: true,
      //     type: "Forward",
      //     title: "Forward",
      //     color: "secondary",
      //     icon: "mdi-arrow-right",
      //   }
      // },
    },
    created(){
      this.onPageLoad()
    },
    template: `
    <?!= include_('dashboard/view/leaves/receivedleaves.html'); ?>
    `
  }

  const SentLeaves = {
    data: ()=>({
      page: 1,
      pageSize: -1,
      headers: [
        {text: "ID", value: "id"},
        {text: "Leave Type", value: "leaveTypes"},
        {text: "Lý do", value: "requestReason"},
        {text: "Chi tiết ngày nghỉ", value: "dataLeaveDays"},
        {text: "Chi tiết phê duyệt", value: "dataApprovals"},
        {text: "Status", value: "status"},
        {text: "Created At", value: "createdAt"},
      ],
    }),
    computed:{
      ...Vuex.mapState({
        loading: 'loading',
        loginUser: 'loginUser',
        statusColor: 'statusColor',
        leaveRequests: 'leaveRequests',
      }),
      ...Vuex.mapGetters({
        items: 'sentLeaves',
      }),
    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      async onPageLoad(){
        this.$store.dispatch("getItems", {
          getItemDB: "leaveDaysDatabase",
          sheetName: "leaveRequests", 
          page: this.page, 
          pageSize: this.pageSize, 
          filters: {
            requestedBy: this.loginUser.employee_email,
          },
        })
        
      },
    },
    created(){
      this.onPageLoad()
    },
    template: `
    <?!= include_('dashboard/view/leaves/sentleaves.html'); ?>
    `
  }


  const Users = {
    data: ()=>({
      page: 1,
      pageSize: -1,
      headers: [
        {text: "Mã nhân viên", value: "Employee_code"},
        {text: "Tên nhân viên", value: "cv_name"},
        {text: "Team", value: "department"},
        {text: "Vị trí", value: "position"},
        {text: "Cấp bậc", value: "level"},
        {text: "Email", value: "employee_email"},
        // {text: "Details", value: "data", width: "500"},
        // {text: "Modified On", value: "modifiedOn"},
        {text: "Ngày vào công ty", value: "onboard_date"},
      ],
      search: Utils.copyObject(Forms.Search),
    }),
    computed: {
      ...Vuex.mapState({
        loading: "loading",
        loginUser: "loginUser",
        users: "users",
        usersTeamSearch: "usersTeamSearch",
        statusColor: 'statusColor',
      }),
      ...Vuex.mapGetters({
        isAdmin: "isAdmin",
        isHR: "isHR",
        userTeamFilter: "userTeamFilter",
      }),

    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      async onPageLoad(){
          this.$store.dispatch("getItems", {
          getItemDB: "userDatabase", 
          sheetName: "users", 
          page: this.page, 
          pageSize: this.pageSize,
          })
      },
      onSearch(){
        if (!this.search.value){
          this.$store.dispatch("getUsersTeamSearch", {getItemDB: "userDatabase", sheetName: "users", page: this.page, pageSize: 60, filters: { department: this.loginUser.department}})
        }else{
          const filters = {
            Employee_code: this.search.value,
            cv_name: this.search.value,
            employee_email: this.search.value,
            department: this.search.value,
          }
          this.$store.dispatch("getUsersTeamSearch", {getItemDB: "userDatabase", sheetName: "users", page: this.page, pageSize: 60, filters})
        }
      },
    },
    watch:{
      page: function(){
        this.onPageLoad()
      },
    },
    created(){
      this.onPageLoad()
    },
    template: `
    <?!= include_('dashboard/view/users.html'); ?>
    `
  }



  const UserProfile = {
    data: ()=>({
      updateProfileForm: Utils.copyObject(Forms.UpdateProfileForm, true),
      dialogUpdateProfile: {},
    }),
    computed:{
      ...Vuex.mapState({
        loading: 'loading',
        loginUser: 'loginUser',
        statusColor: 'statusColor',
      }),
    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      showUpdateProfileForm(item){
        const loginUser = this.$store.state.loginUser
        this.updateProfileForm = Utils.copyObject(Forms.UpdateProfileForm, true)
        this.updateProfileForm.employeeName.items = loginUser.cv_name
        this.updateProfileForm.employeeCode.items = loginUser.Employee_code
        this.updateProfileForm.position.items = loginUser.position
        this.$refs.updateProfileForm && this.$refs.updateProfileForm.resetValidation()
        this.dialogUpdateProfile = {
          show: true,
          type: "Create",
          title: "Yêu cầu cập nhật thông tin hồ sơ",
          color: "primary",
          icon: "mdi-plus",
        }
      },
      async submitUpdateProfileForm(){
        if (!this.$refs.updateProfileForm.validate()) return
        const item = Utils.getFormValues(this.updateProfileForm)
        item.createdAt = new Date()
        item.idStatus = 'Waiting Approve'
        // console.log(item)
        const success = await this.$store.dispatch("createItem", { createItemDB: "employeeInformationDatabase", sheetName: "updateProfileRequests", item})
        if (success) this.dialogUpdateProfile.show = false
      },
    },
    template: `
      <?!= include_('dashboard/view/profile.html'); ?>
      `
  }




  const WorkingCalendar = {
    data: () => ({
      page: 1,
      pageSize: -1,
      headers: [
        {text: "Mã nhân viên", value: "employeeCode"},
        {text: "Tên nhân viên", value: "employeeName"},
        {text: "Team", value: "department"},
        {text: "Vị trí", value: "position"},
        {text: "Ca đầu", value: "startShift"},
        {text: "Ngày đầu", value: "startDate"},
      ],
      type: 'month',
      types: [
        {text: 'Tháng', value: 'month'},
        {text: 'Tuần', value: 'week'},
        {text: 'Ngày', value: 'day'}
      ],
      mode: 'stack',
      modes: ['stack', 'column'],
      weekday: [1, 2, 3, 4, 5, 6, 0],
      weekdays: [
        { text: 'Mon - Sun', value: [1, 2, 3, 4, 5, 6, 0] },
        { text: 'Sun - Sat', value: [0, 1, 2, 3, 4, 5, 6] },
      ],
      value: '',
      events: [],
      // colors: ['blue', 'indigo', 'deep-purple', 'cyan', 'green'],
      names: ['Ngày làm việc', 'Nghỉ phép năm', 'Làm việc tại nhà', 'Nghỉ bù', 'Nghỉ không lương'],
      selectedEvent: {},
      selectedElement: null,
      selectedOpen: false,
      selectXlsx: null,
    }),
    computed: {
      ...Vuex.mapState({
        loading: "loading",
        loginUser: "loginUser",
        statusColor: 'statusColor',
        workingCalendar: 'workingCalendar',
      }),
      ...Vuex.mapGetters({
        isAdmin: "isAdmin",
        isHR: "isHR",
        workingCalendarFilter: "workingCalendarFilter",
      }),

    },

    methods: {
      viewDay ({ date }) {
        this.focus = date
        this.type = 'day'
      },
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      async onPageLoad(){
          this.$store.dispatch("getItems", {
          getItemDB: "workingCalendarDatabase", 
          sheetName: "workingCalendar", 
          page: this.page, 
          pageSize: this.pageSize,
          filters: {
            employeeCode: this.loginUser.Employee_code,
            },
          })
          this.$store.dispatch("getItems", {
          getItemDB: "leaveDaysDatabase", 
          sheetName: "leaveTracking", 
          page: this.page, 
          pageSize: this.pageSize,
          filters: {
            employeeCode: this.loginUser.Employee_code,
            
            },
          })
      },
      convertItemsToEvents(items) {
        const events = [];
        items.forEach(item => {
          const a1 = new Date(item.startDate);
          const a2 = new Date(item.startShift)

          const b1 = new Date(item.endDate)
          const b2 = new Date(item.endShift)

          const startDateTime = new Date(a1.getFullYear(),a1.getMonth(),a1.getDate(),a2.getHours(),a2.getMinutes())
          const endDateTime = new Date(b1.getFullYear(),b1.getMonth(),b1.getDate(),b2.getHours(),b2.getMinutes())

          const event = {
            name: item.workingTimeTypeName || item.leaveTypes ,
            start: startDateTime,
            end: endDateTime,
            color: this.getEventColor({ name: item.workingTimeTypeName || item.leaveTypes }),
            timed: true,
            details: 'Từ ' + startDateTime.toLocaleString() + ' đến ' + endDateTime.toLocaleString() ,
          };
          events.push(event);
        });
        // console.log(events)
        return events;
      },
      getEventColor (event) {
        const colorMap = {
        'Ngày làm việc': 'cyan',
        'Nghỉ phép năm': 'indigo',
        'Làm việc tại nhà': 'deep-purple',
        'Nghỉ bù': 'accent',
        'Nghỉ không lương': 'green',
      };
      return colorMap[event.name] || 'grey darken-1';
      },
      showEvent ({ nativeEvent, event }) {
        const open = () => {
          this.selectedEvent = event
          this.selectedElement = nativeEvent.target
          requestAnimationFrame(() => requestAnimationFrame(() => this.selectedOpen = true))
        }

        if (this.selectedOpen) {
          this.selectedOpen = false
          requestAnimationFrame(() => requestAnimationFrame(() => open()))
        } else {
          open()
        }
        nativeEvent.stopPropagation()
      },
      uploadXlsx() {
          if (!this.selectXlsx) {
            console.log("Please upload a xlsx file")
            return;
          }
          if (this.selectXlsx) {
            const reader = new FileReader();
            reader.onload = (e) => {
              /* Parse data */
              const bstr = e.target.result;
              const wb = XLSX.read(bstr, { type: "binary" });
              /* Get first worksheet */
              const wsname = wb.SheetNames[0];
              const ws = wb.Sheets[wsname];
              /* Convert array of arrays */
              const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
               
              console.log(data);
            };

            reader.readAsBinaryString(this.selectXlsx);
          }
          this.selectXlsx = null;
      },

    },
    watch:{
      page: function(){
        this.onPageLoad()
      },
    },
    created(){
      this.onPageLoad()
    },
    template: `
      <?!= include_('dashboard/view/workingcalendar.html'); ?>
      `
  }



  const ResignHandover = {
    data: ()=>({
      page: 1,
      pageSize: -1,
      headers: [
        {text: "Mã nhân viên", value: "employeeCode"},
        {text: "Tên nhân viên", value: "employeeName"},
        {text: "Team", value: "department"},
        {text: "Lý do", value: "resignReason"},
        {text: "Ngày nghỉ việc", value: "resignDate"},
        {text: "Chi tiết bàn giao", value: "dataHandover"},
        {text: "Status", value: "status"},
        {text: "Actions", value: "actions"},
      ],
      form: Utils.copyObject(Forms.ApprovalForm, true),
      dialog: {},
      comments: {
        label: "Comments",
        value: null,
        type: "textarea",
        icon: "mdi-comment-text",
      },
    }),
    computed:{
      ...Vuex.mapState({
        loading: 'loading',
        loginUser: 'loginUser',
        statusColor: 'statusColor',
      }),
      ...Vuex.mapGetters({
        items: 'resignList',
      }),
    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      async onPageLoad(){
        this.$store.dispatch("getItems", {
          getItemDB: "resignDatabase",
          sheetName: "resignEmployeeHandover", 
          page: this.page, 
          pageSize: this.pageSize, 
          filters: {
            status: "Pending",  
          },
        })
      },
      async submit(){
        if (!this.$refs.form.validate()) return
        const item = {
          id: this.form.id.value,
          comments: this.comments.value,
          type: this.dialog.type,
          completeEmail: this.loginUser.employee_email
        }
        const success = await this.$store.dispatch("updateCompleteHandover", {updateResignDB: "resignDatabase", sheetName: "resignEmployeeHandover",item})
        // console.log(item)
        if (success) this.dialog.show = false
        await this.onPageLoad()
      },
      showCompletedForm(item){
        this.form = Utils.copyObject(Forms.ApprovalForm, true)
        Utils.updateFormValues(this.form, item, true)
        this.$refs.form && this.$refs.form.resetValidation()
        this.comments.value = null
        this.dialog = {
          show: true,
          type: "Complete",
          title: "Complete",
          color: "success",
          icon: "mdi-check",
        }
      },
    },
    created(){
      this.onPageLoad()
    },
    template: `
    <?!= include_('dashboard/view/resignlist/resignhandover.html'); ?>
    `
  }



  const routes = [
    { path: '/', component: Dashboard, meta: {icon: "mdi-view-dashboard", title: "Dashboard"} },
    { path: '/login', component: LoginView, meta: {icon: "mdi-login", title: "Login"}},
    { path: '/sentleaves', component: SentLeaves, meta: {title: "Đơn đã gửi"} },
    { path: '/receivedleaves', component: ReceivedLeaves, meta: {title: "Đơn đã nhận"} },
    { path: '/users', component: Users, meta: {icon: "mdi-microsoft-teams", title: "Danh sách Team Users"} },
    { path: '/profile', component: UserProfile, meta: {icon: "mdi-account", title: "Hồ sơ nhân viên"} },
    { path: '/workingcalendar', component: WorkingCalendar, meta: {icon: "mdi-calendar-account", title: "Lịch làm việc"} },
    { path: '/resignhandover', component: ResignHandover, meta: {icon: "mdi-list-status", title: "Bàn giao nghỉ việc"} },
  
  ]

  const router = new VueRouter({
    routes
  })

    
  // router.beforeEach((to, from, next) => {
  //   const token = Utils.getStorageItem(Utils.Key.Token)
  //   if (!token) return next(`/`)
  //   return store.dispatch("/", {token})
  // })
  

  //  router.afterEach((to, from) => {
  //   Utils.setStorageItem(Utils.Key.Path, to.path)
  //   google.script.history.push(null, null, to.path)
  // })

</script>



