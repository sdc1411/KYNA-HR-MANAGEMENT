<script src="https://unpkg.com/vue-router@3"></script>
<!-- <script src="https://res.cloudinary.com/dpwmd0kym/raw/upload/v1692100348/unpkg.com_vue-router_3.6.5_dist_vue-router_tabjvt.js"></script> -->
 <?!= include_("dashboard/Components/LeaveForm/LeaveForm.html"); ?>
 <?!= include_("dashboard/Components/ResignForm/ResignForm.html"); ?>
 <?!= include_("dashboard/Components/ReviewForm/ReviewForm.html"); ?>
 <?!= include_("dashboard/Components/UpdateProfileForm/UpdateProfileForm.html"); ?>
 <?!= include_('dashboard/Pages/WorkingCalendar/SelfWorkingCalendar.html'); ?>
 <?!= include_('dashboard/Pages/WorkingCalendar/TeamWorkingCalendar.html'); ?>
 <?!= include_('dashboard/Pages/WorkingCalendar/CreateWorkingShift.html'); ?>
 <?!= include_('dashboard/Pages/WorkingCalendar/CreateWorkingCalendar.html'); ?>
 <?!= include_('dashboard/Pages/WorkingCalendar/GetTimeSheet.html'); ?>
 <?!= include_('dashboard/Pages/Leaves/LeavesList.html'); ?>

<script>

  const LoginView = {
    data: () =>({
      form: Utils.copyObject(Forms.Login, true),
    }),
    computed: {
      ...Vuex.mapState({
        loading: "loading",
        statusColor: 'statusColor',
      })
    },
    methods: {
      async login(){
        if (!this.$refs.form.validate()) return
        const item = Utils.getFormValues(this.form)
        // console.log(this.form)
        const success = await this.$store.dispatch("login", {item})
      },
      // async logOut() {
      //   const sucess = await this.$store.dispatch("logOut")
      //   // console.log("ok")
      // },
      async loginWithGoogle() {
        const success = await this.$store.dispatch("loginWithGoogle")
      }
    },
    template: `
      <?!= include_('dashboard/Pages/Login_template.html'); ?>
    `
  }

  const Dashboard = {
    data: ()=>({
      itemsSection: [
        {
          color: '#E91E63',
          src: 'https://res.cloudinary.com/dpwmd0kym/image/upload/v1692336491/Kyna%20Project/v-card/Sotaynhanvien_kyqznt.png',
          title: 'Sổ tay nhân viên',
          subtitle: 'Lịch sử hình thành Kyna, văn hóa Kyna',
          showDialog: false,
          content: '<iframe src="https://docs.google.com/presentation/d/e/2PACX-1vSryW4Q24wZXk0vQXYZlFv8dCZH4Mo93n3FfTtnTajxF_Q5nVAPG6SA_ChhKwi7-ThtDrN8sC3mbnBm/embed?start=false&loop=false&delayms=3000" frameborder="1" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>',
        },
        {
          color: 'warning',
          src: 'https://res.cloudinary.com/dpwmd0kym/image/upload/v1692335664/Kyna%20Project/v-card/Noiquylaodong_no7a9l.png',
          title: 'Nội quy lao động',
          subtitle: 'Quy tắc, quy chế làm việc của Kyna',
          showDialog: false,
          content: '<iframe src="https://docs.google.com/document/d/e/2PACX-1vT0pBK2lzrCA8DtCXxC8KDz5UOObyaANqfWkE14Lhse0DRZeKg_fx2e6kDn7m5WFRYk4TwEu1neI7pk/pub?embedded=true" frameborder="1" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>',
        },
        {
          color: 'info',
          src: 'https://res.cloudinary.com/dpwmd0kym/image/upload/v1692335344/Kyna%20Project/v-card/Quytrinhnhansu_wklfpl.png',
          title: 'Quy trình cần biết',
          subtitle: 'Quy trình thanh toán, nghỉ phép...',
          showDialog: false,
          content: '<iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ24R-MKiQJrTOjfxDSC6VfN4Z2OBkCGLgWZHKraKeXID92OtUaegm2StIbDKj5nAmfzLEuRY8VpD6_/pubhtml?widget=true&amp;headers=false" frameborder="1" width="960" height="569" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>'
        },
      ],
    }),
    computed:{
      ...Vuex.mapState({
        loading: 'loading',
      }),
    },
    methods: {
      async onPageLoad(){
        // const loginUser = this.$store.state.loginUser 
      },
    },
    created(){
      // this.onPageLoad()
    },
    template: `<div>
      <?!= include_('dashboard/Pages/HomeSection1_template.html') ?>
      <?!= include_('dashboard/Pages/HomeSection2_template.html') ?>
    </div>`
  }


  const ReceivedLeaves = {
    data: ()=>({
      page: 1,
      pageSize: -1,
      headers: [
        // {text: "ID", value: "id"},
        {text: "Mã nhân viên", value: "employeeCode"},
        {text: "Tên nhân viên", value: "employeeName"},
        {text: "Team", value: "department"},
        {text: "Leave Type", value: "leaveTypes"},
        {text: "Lý do", value: "requestReason"},
        {text: "Chi tiết ngày nghỉ", value: "dataLeaveDays"},
        {text: "Status", value: "status"},
        {text: "Created At", value: "createdAt"},
        {text: "Actions", value: "actions"},
      ],
      form: Utils.copyObject(Forms.LeaveForm, true),
      search: Utils.copyObject(Forms.Search),
      dialog: {},
      comments: {
        label: "Comments",
        value: null,
        type: "textarea",
        icon: "mdi-comment-text",
      },
    }),
    computed:{
      ...Vuex.mapState({
        loading: 'loading',
        loginUser: 'loginUser',
        statusColor: 'statusColor',
      }),
      ...Vuex.mapGetters({
        items: 'receivedLeaves',
        assignedToEmails: 'assignedToEmails',
      }),
    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      async onPageLoad(){
        this.$store.dispatch("getItems", {
          database: "leaveDaysDatabase",
          sheetName: "leaveRequests", 
          page: this.page, 
          pageSize: this.pageSize, 
          filters: {
            pendingOn: this.loginUser.employee_email,
            status: "Pending",  
          },
        })
      },
      async submit(){
        if (!this.$refs.form.validate()) return
        const item = {
          id: this.form.id.value,
          employeeName: this.form.employeeName.value,
          department: this.form.department.value,
          comments: this.comments.value,
          assignedToEmails: this.form.assignedToEmails.value,
          type: this.dialog.type,
        }
        const success = await this.$store.dispatch("updateApproval", {database: "leaveDaysDatabase", sheetName: "leaveRequests",item})
        // console.log(item)
        if (success) this.dialog.show = false
        await this.onPageLoad()
      },
      showApproveForm(item){
        this.form = Utils.copyObject(Forms.LeaveForm, true)
        this.form.assignedToEmails.items = this.assignedToEmails
        Utils.updateFormValues(this.form, item, true)
        this.$refs.form && this.$refs.form.resetValidation()
        this.comments.value = null
        this.dialog = {
          show: true,
          type: "Approve",
          title: "Approve",
          color: "success",
          icon: "mdi-check",
        }
      },
      showRejectForm(item){
        this.form = Utils.copyObject(Forms.LeaveForm, true)
        this.form.assignedToEmails.items = this.assignedToEmails
        Utils.updateFormValues(this.form, item, true)
        this.$refs.form && this.$refs.form.resetValidation()
        this.comments.value = null
        this.dialog = {
          show: true,
          type: "Reject",
          title: "Reject",
          color: "error",
          icon: "mdi-close",
        }
      },
      showForwardForm(item){
        this.form = Utils.copyObject(Forms.LeaveForm, true)
        this.form.assignedToEmails.items = this.assignedToEmails.filter(v => !item.assignedToEmails.includes(v) && item.requestedBy !== v)
        Utils.updateFormValues(this.form, item)
        this.form.assignedToEmails.value = null
        this.form.assignedToEmails.multiple = false
        this.$refs.form && this.$refs.form.resetValidation()
        this.comments.value = null
        this.dialog = {
          show: true,
          type: "Forward",
          title: "Forward",
          color: "secondary",
          icon: "mdi-arrow-right",
        }
      },
    },
    created(){
      this.onPageLoad()
    },
    template: `
    <?!= include_('dashboard/Pages/Leaves/ReceivedLeaves_template.html'); ?>
    `
  }

  const SentLeaves = {
    data: ()=>({
      page: 1,
      pageSize: -1,
      headers: [
        {text: "ID", value: "id"},
        {text: "Leave Type", value: "leaveTypes"},
        {text: "Lý do", value: "requestReason"},
        {text: "Chi tiết ngày nghỉ", value: "dataLeaveDays"},
        {text: "Chi tiết phê duyệt", value: "dataApprovals"},
        {text: "Status", value: "status"},
        {text: "Created At", value: "createdAt"},
      ],
    }),
    computed:{
      ...Vuex.mapState({
        loading: 'loading',
        loginUser: 'loginUser',
        statusColor: 'statusColor',
        leaveRequests: 'leaveRequests',
      }),
      ...Vuex.mapGetters({
        items: 'sentLeaves',
      }),
    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      async onPageLoad(){
        this.$store.dispatch("getItems", {
          database: "leaveDaysDatabase",
          sheetName: "leaveRequests", 
          page: this.page, 
          pageSize: this.pageSize, 
          filters: {
            requestedBy: this.loginUser.employee_email,
          },
        })
        
      },
    },
    created(){
      this.onPageLoad()
    },
    template: `
    <?!= include_('dashboard/Pages/Leaves/SentLeaves_template.html'); ?>
    `
  }


  const Users = {
    data: ()=>({
      page: 1,
      pageSize: -1,
      headers: [
        {text: "Mã nhân viên", value: "Employee_code"},
        {text: "Tên nhân viên", value: "cv_name"},
        {text: "Team", value: "department"},
        {text: "Vị trí", value: "position"},
        {text: "Cấp bậc", value: "level"},
        {text: "Email", value: "employee_email"},
        // {text: "Details", value: "data", width: "500"},
        // {text: "Modified On", value: "modifiedOn"},
        {text: "Ngày vào công ty", value: "onboard_date"},
      ],
      search: Utils.copyObject(Forms.Search),
    }),
    computed: {
      ...Vuex.mapState({
        loading: "loading",
        loginUser: "loginUser",
        users: "users",
        usersTeamSearch: "usersTeamSearch",
        statusColor: 'statusColor',
      }),
      ...Vuex.mapGetters({
        isAdmin: "isAdmin",
        isHR: "isHR",
        userTeamFilter: "userTeamFilter",
      }),

    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      async onPageLoad(){
          this.$store.dispatch("getItems", {
          database: "userDatabase", 
          sheetName: "users", 
          page: this.page, 
          pageSize: this.pageSize,
          })
      },
      onSearch(){
        if (!this.search.value){
          this.$store.dispatch("getUsersTeamSearch", {database: "userDatabase", sheetName: "users", page: this.page, pageSize: 60, filters: { department: this.loginUser.department}})
        }else{
          const filters = {
            Employee_code: this.search.value,
            cv_name: this.search.value,
            employee_email: this.search.value,
            department: this.search.value,
          }
          this.$store.dispatch("getUsersTeamSearch", {database: "userDatabase", sheetName: "users", page: this.page, pageSize: 60, filters})
        }
      },
    },
    watch:{
      page: function(){
        this.onPageLoad()
      },
    },
    created(){
      this.onPageLoad()
    },
    template: `
    <?!= include_('dashboard/Pages/Users/Users_template.html'); ?>
    `
  }



  const UserProfile = {
    data: ()=>({
    }),
    computed:{
      ...Vuex.mapState({
        loading: 'loading',
        loginUser: 'loginUser',
        statusColor: 'statusColor',
      }),
    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
    },
    template: `
      <?!= include_('dashboard/Pages/Profile_template.html'); ?>
      `
  }


  const ResignHandover = {
    data: ()=>({
      page: 1,
      pageSize: -1,
      headers: [
        {text: "Mã nhân viên", value: "employeeCode"},
        {text: "Tên nhân viên", value: "employeeName"},
        {text: "Team", value: "department"},
        {text: "Lý do", value: "resignReason"},
        {text: "Ngày nghỉ việc", value: "resignDate"},
        {text: "Chi tiết bàn giao", value: "dataHandover"},
        {text: "Status", value: "status"},
        {text: "Actions", value: "actions"},
      ],
      form: Utils.copyObject(Forms.ApprovalForm, true),
      dialog: {},
      comments: {
        label: "Comments",
        value: null,
        type: "textarea",
        icon: "mdi-comment-text",
      },
    }),
    computed:{
      ...Vuex.mapState({
        loading: 'loading',
        loginUser: 'loginUser',
        statusColor: 'statusColor',
      }),
      ...Vuex.mapGetters({
        items: 'resignList',
      }),
    },
    methods: {
      formatDate(date) {
        if (!date) return ''; // Return an empty string if date is undefined

        const formattedDate = new Date(date);
        const day = formattedDate.getDate().toString().padStart(2, '0');
        const month = (formattedDate.getMonth() + 1).toString().padStart(2, '0'); // Note: Month is zero-based
        const year = formattedDate.getFullYear();

        return `${day}/${month}/${year}`;
      },
      async onPageLoad(){
        this.$store.dispatch("getItems", {
          database: "resignDatabase",
          sheetName: "resignEmployeeHandover", 
          page: this.page, 
          pageSize: this.pageSize, 
          filters: {
            status: "Pending",  
          },
        })
      },
      async submit(){
        if (!this.$refs.form.validate()) return
        const item = {
          id: this.form.id.value,
          comments: this.comments.value,
          type: this.dialog.type,
          completeEmail: this.loginUser.employee_email
        }
        const success = await this.$store.dispatch("updateCompleteHandover", {database: "resignDatabase", sheetName: "resignEmployeeHandover",item})
        // console.log(item)
        if (success) this.dialog.show = false
        await this.onPageLoad()
      },
      showCompletedForm(item){
        this.form = Utils.copyObject(Forms.ApprovalForm, true)
        Utils.updateFormValues(this.form, item, true)
        this.$refs.form && this.$refs.form.resetValidation()
        this.comments.value = null
        this.dialog = {
          show: true,
          type: "Complete",
          title: "Complete",
          color: "success",
          icon: "mdi-check",
        }
      },
    },
    created(){
      this.onPageLoad()
    },
    template: `
    <?!= include_('dashboard/Pages/ResignList/ResignHandover_template.html'); ?>
    `
  }


  const WorkingCalendar = {
    props: ["id"],
    data: ()=>({
      activeTab: "/WorkingCalendar",
      tabs: [
        { id: 1, name: "Lịch làm việc cá nhân", route: "/WorkingCalendar" },
        { id: 2, name: "Lịch làm việc Team", route: "/WorkingCalendar/TeamWorkingCalendar"},
        { id: 3, name: "Tạo lịch làm việc", route: "/WorkingCalendar/CreateWorkingCalendar"},
        { id: 4, name: "Tạo ca làm việc", route: "/WorkingCalendar/CreateWorkingShift"},
        { id: 5, name: "Tải dữ liệu chấm công", route: "/WorkingCalendar/GetTimeSheet"},
      ]
    }),
    template: `
      <?!= include_('dashboard/Pages/WorkingCalendar/WorkingCalendar_template.html'); ?>
      `
  }


  const routes = [
    { path: '/', component: Dashboard, meta: {icon: "mdi-view-dashboard", title: "Dashboard"} },
    { path: '/Login', component: LoginView, meta: {icon: "mdi-login", title: "Login"}},
    { path: '/SentLeaves', component: SentLeaves, meta: {title: "Đơn đã gửi"} },
    { path: '/ReceivedLeaves', component: ReceivedLeaves, meta: {title: "Đơn đã nhận"} },
    { path: '/LeavesList', component: LeavesList, meta: {title: "Lịch nghỉ phép Team"} },
    { path: '/Users', component: Users, meta: {icon: "mdi-microsoft-teams", title: "Danh sách Team Users"} },
    { path: '/Profile', component: UserProfile, meta: {icon: "mdi-account", title: "Hồ sơ nhân viên"} },
    { path: "/WorkingCalendar", component: WorkingCalendar, prop: true, meta:{icon:"mdi-calendar-account",title: "Lịch làm việc"} , children: [
      { path: "", component: SelfWorkingCalendar, meta:{icon:"mdi-calendar-account",title: "Lịch làm việc cá nhân"} },
      { path: "TeamWorkingCalendar", component: TeamWorkingCalendar },
      { path: "CreateWorkingCalendar", component: CreateWorkingCalendar },
      { path: "CreateWorkingShift", component: CreateWorkingShift },
      { path: "GetTimeSheet", component: GetTimeSheet }
      ]},
    { path: '/ResignHandover', component: ResignHandover, meta: {icon: "mdi-list-status", title: "Bàn giao nghỉ việc"} },
  
  ]

  const router = new VueRouter({
    routes
  })

    
  // router.beforeEach((to, from, next) => {
  //   const token = Utils.getStorageItem(Utils.Key.Token)
  //   if (!token) return next(`/`)
  //   return store.dispatch("/", {token})
  // })
  

  //  router.afterEach((to, from) => {
  //   Utils.setStorageItem(Utils.Key.Path, to.path)
  //   google.script.history.push(null, null, to.path)
  // })

</script>



