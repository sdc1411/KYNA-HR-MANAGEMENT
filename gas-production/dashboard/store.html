<script src="https://unpkg.com/vuex@3.x"></script>
<!-- <script src="https://res.cloudinary.com/dpwmd0kym/raw/upload/v1692100272/unpkg.com_vuex_3.6.2_dist_vuex_g4fkb0.js"></script> -->

<script>
  const store = new Vuex.Store({
    state: {
      barColor: 'rgba(0, 0, 0, .8), rgba(0, 0, 0, .8)',
      loading: false,
      statusLogin: false,
      app: {
        name: "KYNA HR DASHBOARD",
        title: "Welcome to HR Dashboard",
      },
      statusColor: {
        Pending: "warning",
        Approved: "success",
        Rejected: "error",
        Closed: "grey",
        Cancelled: "grey",
        Completed: "success",
      },
      snackbar: {},
      dialog: {},
      loginUser: {
        employee_email: null,
        cv_name: null,
        department: null,
        position: null,
        Employee_code: null,
        login_email: null,
        onboard_date: null,
        candidate_email: null,
        dob: null,
        sex: null,
        current_address: null,
        cmnd_id: null,
        candidate_phone: null,
        bank_account_no: null,
        level: null,
        location: null,
        system_role: null,
        employee_status: null,
      },
      users: {items: [], pages: 1},
      usersTeamSearch: {items: [], pages: 1},
      leaveTypes: {items: [], pages: 1},
      leaveRequests: {items: [], pages: 1},
      workingCalendar: {items: [], pages: 1},
      leaveTracking: {items: [], pages: 1},
      resignEmployeeHandover: {items: [], pages: 1},
      workingTimeType: {items: [], pages: 1},
      workingCalendarRequests: {items: [], pages: 1},
    },
    getters: {
      isKynaEmail: function(state){
        const loginEmail = state.loginUser.login_email
        return loginEmail.includes("@kynaforkids.vn") ? true : false
      },
      isAdmin: function(state){
        return state.loginUser.system_role == "Admin" ? true : false
      },
      isHR: function(state){
        return state.loginUser.system_role == "HR" ? true : false
      },
      isManager: function(state){
        return state.loginUser.system_role == "Manager" ? true : false
      },
      isAuthLeaveHandover: function(state) {
        return (state.loginUser.employee_email == "long.duong@kynaforkids.vn" || state.loginUser.level == "C-level" || state.loginUser.level == "Director" || state.loginUser.level == "Manager") ? true : false
      },
      assignedToEmails: function(state){
        return (state.loginUser.level == 'Manager' || state.loginUser.level == 'Director' || state.loginUser.level == 'C-level' || state.loginUser.system_role == 'HR' || state.loginUser.system_role == 'Admin') 
        ? state.users.items.filter(item => item.employee_email !== state.loginUser.employee_email && item.level == 'Supervisor' || item.level == 'Director' || item.level == 'Manager' || item.level == 'C-level' ).map(item => item.employee_email) 
        : state.users.items.filter(item => item.employee_email !== state.loginUser.employee_email && item.department == state.loginUser.department).map(item => item.employee_email)
      },
      listEmployeeName: function(state){
        return (state.loginUser.system_role == 'Manager' || state.loginUser.system_role == 'HR' || state.loginUser.system_role == 'Admin') 
        ? state.users.items.filter(item => item.employee_email !== state.loginUser.employee_email && item.level == 'Supervisor' || item.level == 'Director' || item.level == 'Manager' || item.level == 'C-level' ).map(item => item.cv_name) 
        : state.users.items.filter(item => item.employee_email !== state.loginUser.employee_email && item.department == state.loginUser.department).map(item => item.cv_name)
      },
      listEmployeeCode: function(state){
        return (state.loginUser.system_role == 'Manager' || state.loginUser.system_role == 'HR' || state.loginUser.system_role == 'Admin') 
        ? state.users.items.filter(item => item.employee_email !== state.loginUser.employee_email && item.level == 'Supervisor' || item.level == 'Director' || item.level == 'Manager' || item.level == 'C-level' ).map(item => item.Employee_code) 
        : state.users.items.filter(item => item.employee_email !== state.loginUser.employee_email && item.department == state.loginUser.department).map(item => item.Employee_code)
      },
      listDepartments: function(state){
        return (state.loginUser.system_role == 'Manager' || state.loginUser.system_role == 'HR' || state.loginUser.system_role == 'Admin')
        ? state.users.items.map(item => item.department)
        : state.users.items.filter(item => item.department == state.loginUser.department).map(item => item.department)
      },
      listLeaveTypes: function(state){
        return state.leaveTypes.items.map(item => item.leaveTypeName)
      },
      sentLeaves: function(state){
        return state.leaveRequests.items.filter(item => item.requestedBy == state.loginUser.employee_email)
      },
      receivedLeaves: function(state){
        return state.leaveRequests.items.filter(item => item.pendingOn == state.loginUser.employee_email)
      },
      receivedLeavesQty: function(state){
        return state.leaveRequests.items.filter(item => item.pendingOn == state.loginUser.employee_email && item.status === 'Pending').length
      },
      sentLeavesQty: function(state){
        return state.leaveRequests.items.filter(item => item.requestedBy == state.loginUser.employee_email && item.status === 'Pending').length
      },
      workingCalendarFilter: function(state){
        const workingCalendar = state.workingCalendar.items.filter(item => item.employeeCode == state.loginUser.Employee_code && item.idStatus === 'Approved')
        const leaveTracking = state.leaveTracking.items.filter(item => item.employeeCode == state.loginUser.Employee_code)
        leaveTracking.forEach((item) => {
          workingCalendar.push(item)
        })
        return workingCalendar
      },
      userTeamFilter: function(state){
        return (state.loginUser.system_role == 'Admin' || state.loginUser.system_role == 'HR') ? state.users.items : state.users.items.filter(item => item.department === state.loginUser.department)
      },
      resignList: function(state){
        return (state.loginUser.system_role === 'Admin' || state.loginUser.system_role === 'HR' || state.loginUser.employee_email === 'cb@kynaforkids.vn') ? state.resignEmployeeHandover.items.filter(item => item.status === 'Pending') : state.resignEmployeeHandover.items.filter(item => item.status === 'Pending' && item.department === state.loginUser.department)
      },
    },
    mutations: {
      updateState(state, {key, value}) {
        state[key] = value
      },
      startLoading(state) {
        state.loading = true
      },
      stopLoading(state) {
        state.loading = false
      },
       showDialog(state, dialog){
        state.loading = false
        dialog.show = true
        state.dialog = dialog
      },
      closeDialog(state){
        state.dialog.show = false
      },
      showSnackbar(state, snackbar){
        state.loading = false
        snackbar.show = true
        state.snackbar = snackbar
      },
      closeSnackbar(state){
        state.snackbar.show = false
      },
      },

    actions: {
      async showSnackbar({commit},{color, message}) {
        commit("showSnackbar", {color: color, message: message})
      },
      async getDataLoginUser({commit}, params){
        commit("startLoading")
        try {
          const location = await Utils.getLocation()
          const path = location.path || "/"
          const {success, message, app, loginUser, dataUsers, dataLeaveRequests, dataLeaveTypes} = await Utils.request("getDataLoginUser", params)
          if (!success) {
            commit("updateState", {key: "statusLogin", value: success})
            commit("showSnackbar", {color: "error", message})
            if (path !== "/Login")  {
              router.push("/Login")
            }
            return
          }

          commit("updateState", {key: "statusLogin", value: success})
          commit("updateState", {key: "app", value: app})
          commit("updateState", {key: "loginUser", value: loginUser})
          commit("updateState", {key: "users", value: dataUsers})
          commit("updateState", {key: "leaveTypes", value: dataLeaveTypes})
          commit("updateState", {key: "leaveRequests", value: dataLeaveRequests})
          commit("stopLoading")
          commit("showSnackbar", {color: "success", message})
    
        }catch(err){
          commit("showSnackbar", {color: "error", message: err.message})
        }
      },

      async getItems({commit}, params){
        commit("startLoading")
        // console.log(params)
        try {
          const data = await Utils.request("getItems", params)
          commit("updateState", {key: params.sheetName, value: data})
          // console.log(data)
          commit("stopLoading")
        }catch(err){
          commit("showSnackbar", {color: "error", message: err.message})
        }
      },

      async getUsersTeamSearch({commit}, params){
        commit("startLoading")
        // console.log(params)
        try {
          const data = await Utils.request("getItems", params)
          commit("updateState", {key: "usersTeamSearch", value: data})
          // console.log(data)
          commit("stopLoading")
        }catch(err){
          commit("showSnackbar", {color: "error", message: err.message})
        }
      },

      async createItem({commit}, params){
        commit("startLoading")
        try {
          const {success, message} = await Utils.request("createItem", params)
          if (!success){
            commit("showSnackbar", {color: "error", message})
          }else{
            commit("showSnackbar", {color: "success", message})
            return true
          }
        }catch(err){
          commit("showSnackbar", {color: "error", message: err.message})
        }
      },

      async updateApproval({commit}, params){
        commit("startLoading")
        try {
          const {success, message} = await Utils.request("updateApproval", params)
          if (!success){
            commit("showSnackbar", {color: "error", message})
          }else{
            commit("showSnackbar", {color: "success", message})
            return true
          }
        }catch(err){
          commit("showSnackbar", {color: "error", message: err.message})
        }
      },

      async updateCompleteHandover({commit}, params){
        commit("startLoading")
        try {
          const {success, message} = await Utils.request("updateCompleteHandover", params)
          if (!success){
            commit("showSnackbar", {color: "error", message})
          }else{
            commit("showSnackbar", {color: "success", message})
            return true
          }
        }catch(err){
          commit("showSnackbar", {color: "error", message: err.message})
        }
      },

      async createResignForms({commit}, params){
        commit("startLoading")
        try {
          const {success, message} = await Utils.request("createResignForms", params)
          if (!success){
            commit("showSnackbar", {color: "error", message})
          }else{
            commit("showSnackbar", {color: "success", message})
            return true
          }
        }catch(err){
          commit("showSnackbar", {color: "error", message: err.message})
        }
      },

      async createReviewForm({commit}, params){
        commit("startLoading")
        try {
          const {success, message} = await Utils.request("createReviewForm", params)
          if (!success){
            commit("showSnackbar", {color: "error", message})
          }else{
            commit("showSnackbar", {color: "success", message})
            return true
          }
        }catch(err){
          commit("showSnackbar", {color: "error", message: err.message})
        }
      },

      // async handleWorkingCalendar({commit}, params){
      //   commit("startLoading")
      //   if (params.type === 'Create') {
      //       try {
      //       const {success, message} = await Utils.request("createWorkingCalendar", params)
      //       if (!success){
      //         commit("showSnackbar", {color: "error", message})
      //       }else{
      //         const data = await Utils.request("getItems", {pageSize: -1, database: "workingCalendarDatabase", sheetName: "workingCalendarRequests"})
      //         commit("updateState", {key: "workingCalendarRequests", value: data})
      //         commit("showSnackbar", {color: "success", message})
      //         return true
      //       }
      //     }catch(err){
      //       commit("showSnackbar", {color: "error", message: err.message})
      //     }
      //   } else if (params.type === 'Update' || params.type === 'Import') {
      //     try {
      //       await Utils.request("updateWorkingCalendar", params)
      //       const data = await Utils.request("getItems", {pageSize: -1, database: "workingCalendarDatabase", sheetName: "workingCalendarRequests"})
      //       commit("updateState", {key: "workingCalendarRequests", value: data})
      //     }catch(err){
      //       commit("showSnackbar", {color: "error", message: err.message})
      //     }
      //   } else if (params.type === 'Delete') {
      //     try {
      //       await Utils.request("deleteWorkingCalendar", params)
      //       const data = await Utils.request("getItems", {pageSize: -1, database: "workingCalendarDatabase", sheetName: "workingCalendarRequests"})
      //       commit("updateState", {key: "workingCalendarRequests", value: data})
      //     }catch(err){
      //       commit("showSnackbar", {color: "error", message: err.message})
      //     }
      //   } else {
      //     return commit("showSnackbar", {color: "error", message: 'Type chưa được định nghĩa'})
      //   }
      // },

      async handleWorkingCalendar({ commit }, params) {
        commit("startLoading");
        const processRequest = async () => {
          if (params.type === 'Create') {
            try {
              const { success, message } = await Utils.request("createWorkingCalendar", params);
              if (!success) {
                commit("showSnackbar", { color: "error", message });
              } else {
                const data = await Utils.request("getItems", { pageSize: -1, database: "workingCalendarDatabase", sheetName: "workingCalendarRequests" });
                commit("updateState", { key: "workingCalendarRequests", value: data });
                commit("showSnackbar", { color: "success", message });
              }
            } catch (err) {
              commit("showSnackbar", { color: "error", message: err.message });
            }
          } else if (params.type === 'Update' || params.type === 'Import') {
            try {
              await Utils.request("updateWorkingCalendar", params);
              const data = await Utils.request("getItems", { pageSize: -1, database: "workingCalendarDatabase", sheetName: "workingCalendarRequests" });
              commit("updateState", { key: "workingCalendarRequests", value: data });
            } catch (err) {
              commit("showSnackbar", { color: "error", message: err.message });
            }
          } else if (params.type === 'Delete') {
            try {
              await Utils.request("deleteWorkingCalendar", params);
              const data = await Utils.request("getItems", { pageSize: -1, database: "workingCalendarDatabase", sheetName: "workingCalendarRequests" });
              commit("updateState", { key: "workingCalendarRequests", value: data });
            } catch (err) {
              commit("showSnackbar", { color: "error", message: err.message });
            }
          } else {
            commit("showSnackbar", { color: "error", message: 'Type chưa được định nghĩa' });
          }
        };
        processRequest();
        return Promise.resolve(true);
      },
      
      async login({commit}, params){
        commit("startLoading")
        try {
          const location = await Utils.getLocation()
          const path = location.path || "/"
          const {success, message, loginUser} = await Utils.request("getDataLoginNonUser", params)
          // console.log(loginUser)
          // console.log(params)
          if (!success) {
            commit("updateState", {key: "statusLogin", value: success})
            commit("showSnackbar", {color: "error", message})
            if (path !== "/Login")  {
              router.push("/Login")
            }
            return
          }
          commit("updateState", {key: "statusLogin", value: success})
          commit("updateState", {key: "loginUser", value: loginUser})
          // commit("updateState", {key: "app", value: appInfo})
          if (path !== "/Login") {
            router.push(path)
           } else{
             router.push("/")
           }
          commit("stopLoading")
          commit("showSnackbar", {color: "success", message})
          // console.log(appInfo)
          // console.log(loginUser)
        }catch(err){
          commit("showSnackbar", {color: "error", message: err.message})
        }
      },

      async loginWithGoogle({commit}) {
        commit("startLoading")
        const url = await Utils.request("scripAppUrl")
        const href = "https://accounts.google.com/AccountChooser?continue="+url
        commit("stopLoading")
        window.top.location.href = href
        location.reload(true);
        // window.top.location.href = "https://accounts.google.com/AccountChooser?continue=https://script.google.com/macros/s/AKfycbz2qDOGEP_3291KzE383vV4U7b6BPml9sSGFqdrct-V4_egnHHb4n4_KolzmmzMwOxQ3A/exec";
        // location.reload(true);
      }

    },
  })
</script>